<!DOCTYPE html>
<html>

<head>
  <%- include('_layouts/header') %>
</head>

<body>
  <%- include('_layouts/navbar') %>

  <button id ="btnScrollToTop" class ="btn btn-primary btn-scroll-to-top " >
    <i class = "material-icons">arrow_upward</i>
  </button>

  <div class="custom-category">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-12 text-center">
          <h1 class="section_title text-center">
            Get a loan with the lowest interest rates!
          </h1>
          <p class="text-center">Choose the type of loan you are looking for...</p>
        </div>
      </div>
      <div class="row mt-4 slider_desktop">
        <div class="col-md-1 chevron-margin">
          <a class="btn btn-primary btn-sm btn-round" href="#multi-item-example" data-slide="prev"><i
              class="fa fa-chevron-left"></i></a>
        </div>
        <div class="col-md-10">
          <div id="loader-carousel" class="text-center">
            <div class="spinner-border text-dark mb-5" role="status">
              <span class="sr-only">Loading...</span>
            </div>
          </div>
          <!--Carousel Wrapper-->
          <div id="multi-item-example" class="carousel slide carousel-multi-item" data-ride="carousel">
            <!--Slides-->
            <div class="carousel-inner" role="listbox">
              <div class="carousel-item active">
                <div class="row">
                  <div class="col-md-3">
                    <div id="Home Loan" class="card my-2 p-5 card_slider" style="text-align: center;">
                      <a class="slider_text" href="#"> <i class="material-icons slider_icon">account_balance
                        </i><br />Home Loan</a>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div id="Nari Bachat" class="card my-2 p-5 card_slider" style="text-align: center;">
                      <a class="slider_text"><i class="material-icons slider_icon">
                          face</i><br />Nari Bachat</a>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div id="Kids Savings" class="card my-2 p-5 card_slider" style="text-align: center;">
                      <a class="slider_text"><i class="material-icons  slider_icon">
                          child_care
                        </i><br />Kids Savings</a>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div id="Old Age Saving" class="card my-2 p-5 card_slider" style="text-align: center;">
                      <a class="slider_text"><i class="material-icons  slider_icon">
                          accessibility_new
                        </i><br />Old Age Saving</a>
                    </div>
                  </div>
                </div>
              </div>

            </div>
            <!--/.Slides-->
          </div>
          <!--/.Carousel Wrapper-->

        </div>
        <div class="col-md-1 chevron-margin">
          <a id="next_slide" class="btn btn-primary btn-sm btn-round" href="#multi-item-example" data-slide="next"><i
              class="fa fa-chevron-right"></i></a>
        </div>
      </div>
      <div class="row mt-2 d-lg-none d-block">
        <div class="col-md-6 chevron-margin">
          <a class="btn btn-primary btn-sm btn-round" href="#multi-item-example" data-slide="prev"><i
              class="fa fa-chevron-left"></i></a>
          <a id="next_slide" class="btn btn-primary btn-sm btn-round" href="#multi-item-example" data-slide="next"><i
              class="fa fa-chevron-right"></i></a>
        </div>

        <div class="col-md-12">
        </div>

      </div>
    </div>
  </div>
  <div class="container">
    <section class="custom-category">
      <div class="sort-bar mt-3">
        <div class="mr-2" style="width: 270px;">
          <select id="sort_by" class="px-2 ml-2 custom-select">
            <option value="" disabled selected hidden>Select an option...</option>
            <option>Interest Rate (Low to High)</option>
            <option>Interest Rate (High to Low)</option>
            <option>Base Rate (Low to High)</option>
            <option>Base Rate (High to Low)</option>
            <option>Total Interest Rate (Low to High)</option>
            <option>Total Interest Rate (High to Low)</option>
          </select>
        </div>
        <h4 class="filter_by">
          FILTER BY
        </h4>
      </div>
      <!-- <hr class="mt-0"> -->
      <div id="loader" class="text-center">
        <div class="spinner-border text-dark mb-5" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>
      <div class="loan-card">

        <!-- Append All Data Here -->
      </div>
    </section>
  </div>
  <div id="compare-div" class="compare-popup fixed-bottom">
    <div class="container">
      <h3>
        Compare Loans
      </h3>
      <div class="row ">
        <div class ="col-md-9 row compare-row">         
        </div>        
        <div class="col-md-3 d-flex align-items-center justify-content-end">
          <button class="btn btn-primary" id="compare_button">
            Compare
            </a>
        </div>
      </div>
    </div>
  </div>

  <%- include('_layouts/footer') %>

  <script>
    $('#loader-carousel').hide();
    $('#loader').hide();    
    let rightButtonCounter = 0;
    let appendFunctionCounter = 0;
    let currentLoanData;

    console.log('appendFunctionCounter', appendFunctionCounter);

    $('#next_slide').on('click', () => {
      if (rightButtonCounter == 0) {
        $('#multi-item-example').hide();
        $('#loader-carousel').show();
        /* load all the loan types in carousel */
        $.get('/api/v1/loan-type', {}, (data) => {
          console.log('beginning data loan type');
          console.log(data);
          for (let i = 4; i < data.length - 4; i += 4) {
            $('.carousel-inner').append(`
            <div class="carousel-item">
              <div class="row">
                <div class="col-md-3">
                  <div id="${data[i].account_type}" class="card my-2 p-5 card_slider" style="text-align: center;">
                    <a class="slider_text" href="#"><i class="material-icons slider_icon">attach_money</i><br/> ${data[i].account_type}</a>
                  </div>
                </div>
                <div class="col-md-3">
                  <div id="${data[i + 1].account_type}" class="card my-2 p-5 card_slider" style="text-align: center;">
                    <a class="slider_text" href="#"><i class="material-icons slider_icon">
                        money</i><br/> ${data[i + 1].account_type}</a>
                  </div>
                </div>
                <div class="col-md-3">
                  <div id="${data[i + 2].account_type}" class="card my-2 p-5 card_slider" style="text-align: center;">
                    <a href="#" class="slider_text"><i class="material-icons slider_icon">
                        local_atm
                      </i><br/> ${data[i + 2].account_type}</a>
                  </div>
                </div>
                <div class="col-md-3">
                  <div id="${data[i + 3].account_type}" class="card my-2 p-5 card_slider" style="text-align: center;">
                    <a href="#" class="slider_text"><i class="material-icons slider_icon">
                        local_atm
                      </i><br/> ${data[i + 3].account_type}</a>
                  </div>
                </div>
              </div>
            </div>
          `);
          }
          $('#loader-carousel').hide();
          $('#next_slide').click();
          $('#multi-item-example').show();
        });
        /* load all the loan types in carousel end*/
        rightButtonCounter = rightButtonCounter + 1;
      }
    });

    /* initial text on load card */
    $('.loan-card').append(`
      <div class = "row">
      <div class="col-md-12 text-center mt-2 mb-4">
          Currently there are no bank data to display. Select a loan Category to view the data !
        </div>
      </div>
    `);
    /* initial text on load card */

    /* add data to loan card */
    $('.carousel-item').on('click', function (e) {
      console.log('clicked on carousel item');
      console.log(e.target);
      const idInfo = e.target.parentNode.id || $(e.target).attr('id');
      if (idInfo) {
        let type = idInfo;
        append(type);
      }
    });
    /* add data to loan card */

    /* Append Function add data to loan-card*/
    function append(loan_type) {
      console.log('currentLoanData', currentLoanData);
      $('.loan-card').empty();
      $('#loader').show();
      console.log('loan type', loan_type);
      $.get('/api/v1/all-data', { type: loan_type }, (data) => {
        console.log(data);
        currentLoanData = data;
        console.log('currentLoanData', currentLoanData);
        data.forEach(el => {
          $('.loan-card').append(`
          <div class="row">
            <div class="col-md-12">
                <h4 class="bank_name p-2">${el.bank_name}</h4>
            </div>
          </div>
          <div class="row">     
            <div class="col-md-3 first mt-3">
                <div class="img-container">
                  <img src="/img/primebank.png">
                </div>
            </div>
            <div class="col-md-6 second mt-3">
              <h4 >${el.product_type}</h4>
              <p>${el.product_name}</p>
              <div class="row">
                <div class="col-md-4">
                  <div class="interest_rate">
                    <p>
                      Interest Rate
                    </p>
                    <ul>
                      <li class="interest_rate_add"> ${el.interest_rate} %</li>
                    </ul>
                  </div>
                </div>

                <div class="col-md-4">
                  <div class="interest_rate">
                    <p>
                      Base Rate
                    </p>
                    <ul>
                      <li class="interest_rate_add"> ${el.base_rate} %</li>
                    </ul>
                  </div>
                </div>

                <div class="col-md-4">
                  <div class="interest_rate">
                    <p>
                      Total Interest Rate
                    </p>
                    <ul class="mb-0">
                      <li class="interest_rate_add"> ${el.total_interest_rate} %</li>
                    </ul>
                  </div> 
                </div>
              </div>
            </div>
            <div class="col-md-3 third mt-3">
              <button type="button" class="btn btn-primary">Apply now</button>
              <button type="button" class="btn btn-primary">learn more</button>
              <div class="custom-checkbox">
                <input type="checkbox" id="${el.bank_id}" value="${el.bank_name},</br>${el.product_name}" onclick = "addToCompare(this)">
                <p class="mb-0 ml-3">Select to compare </p> 
              </div>
              <p id="alert-${el.bank_id}" style="color: red; display: none;">Sorry, you cannot add more than 3 loans for comparison</p>             
            </div>
          </div>
          <hr>
        `);
        });
        $('#loader').hide();
      });
      appendFunctionCounter++;
      console.log('appendFunctionCounter', appendFunctionCounter);
    }
    console.log('appendFunctionCounter', appendFunctionCounter);;
    /* append function end */
    console.log('currentLoanData', currentLoanData);

    /* sortedAppend function */
    function sortedAppend(sortedLoanData) {
      sortedLoanData.forEach(el => {
        $('.loan-card').append(`
        <div class="row">
          <div class="col-md-12">
              <h4 class="bank_name p-2">${el.bank_name}</h4>
          </div>
          </div>
          <div class="row">
     
            <div class="col-md-3 first mt-3">
                <div class="img-container">
                  <img src="/img/primebank.png">
                </div>
            </div>
            <div class="col-md-6 second mt-3">
              <h4 >${el.product_type}</h4>
              <p>${el.product_name}</p>
              <div class="row">
              <div class="col-md-4">
              <div class="interest_rate">
                <p>
                  Interest Rate
                </p>
                <ul>
                  <li class="interest_rate_add"> ${el.interest_rate} %</li>
                </ul>
              </div>
              </div>
              <div class="col-md-4">

              <div class="interest_rate">
                <p>
                  Base Rate
                </p>
                <ul>
                  <li class="interest_rate_add"> ${el.base_rate} %</li>
                </ul>
              </div>
              </div>
              <div class="col-md-4">

              <div class="interest_rate">
                <p>
                  Total Interest Rate
                </p>
                <ul class="mb-0">
                  <li class="interest_rate_add"> ${el.total_interest_rate} %</li>
                </ul>
              </div> 
              </div>
              </div>
            </div>
            <div class="col-md-3 third mt-3 ">
              <button type="button" class="btn btn-primary">Apply now</button>
              <button type="button" class="btn btn-primary">learn more</button>
              <div class="custom-checkbox">
                <input type="checkbox" id="${el.bank_id}" value="${el.bank_name},</br>${el.product_name}" onclick = "addToCompare(this)">
                <p class="mb-0 ml-3">Select to compare</p>
              </div>
              <p id="alert-${el.bank_id}" style="color: red; display: none;">Sorry, you cannot add more than 3 loans for comparison</p>
            </div>
          </div>
          <hr>
              `);
      });
    }
    /* sortedAppend function end */

    $('#sort_by').on('change', function () {
      $('#compare-div').hide();
      $('.compare-row').empty();
      compareCounter = 0;
      compareId =[];
      compareName =[];
      console.log('compareCounter after sorting',compareCounter);
      console.log('compareId after sorting',compareId);
      if (appendFunctionCounter > 0) {
        console.log(this.value);
        if (this.value == "Interest Rate (Low to High)") {

          let sortedLoanData = currentLoanData.sort(function (a, b) {
            return a.interest_rate - b.interest_rate;
          });
          console.log('sortedloandata', sortedLoanData);
          $('.loan-card').empty();
          sortedAppend(sortedLoanData);
        }

        if (this.value == "Interest Rate (High to Low)") {
          let sortedLoanData = currentLoanData.sort(function (a, b) {
            return b.interest_rate - a.interest_rate;
          });
          console.log('sortedloandata', sortedLoanData);
          $('.loan-card').empty();
          sortedAppend(sortedLoanData);
        }

        if (this.value == "Base Rate (Low to High)") {

          let sortedLoanData = currentLoanData.sort(function (a, b) {
            return a.base_rate - b.base_rate;
          });
          console.log('sortedloandata', sortedLoanData);
          $('.loan-card').empty();
          sortedAppend(sortedLoanData);
        }

        if (this.value == "Base Rate (High to Low)") {
          let sortedLoanData = currentLoanData.sort(function (a, b) {
            return b.base_rate - a.base_rate;
          });
          console.log('sortedloandata', sortedLoanData);
          $('.loan-card').empty();
          sortedAppend(sortedLoanData);
        }

        if (this.value == "Total Interest Rate (Low to High)") {
          let sortedLoanData = currentLoanData.sort(function (a, b) {
            return a.total_interest_rate - b.total_interest_rate;
          });
          console.log('sortedloandata', sortedLoanData);
          $('.loan-card').empty();
          sortedAppend(sortedLoanData);
        }

        if (this.value == "Total Interest Rate (High to Low)") {
          let sortedLoanData = currentLoanData.sort(function (a, b) {
            return b.total_interest_rate - a.total_interest_rate;
          });
          console.log('sortedloandata', sortedLoanData);
          $('.loan-card').empty();
          sortedAppend(sortedLoanData);
        }


      }
    });


    /* compare part */
    $('#compare-div').hide();   
   
    let compareCounter = 0;
    let compareId = [];
    let compareName =[];
    function addToCompare(checkbox) {
      console.log(checkbox.id);
      if (checkbox.checked) {
        compareCounter++;
        console.log('compareCounter', compareCounter);
        if (compareCounter > 3) {
          console.log('cant add more than 3 items for comparison');
          $('#compare_button').attr("disabled", true);
          console.log('compareId', compareId);
        }
        else {
          $('#compare_button').attr("disabled", false);
          console.log('compareCounter', compareCounter);
          console.log('checked');
          compareId.push(checkbox.id);
          compareName.push(checkbox.value);
          console.log('compareId', compareId);    
          console.log('compareName', compareName);  
          
         
          $('.compare-row').append(`
            <div class = "col-md-4" id="compare-${checkbox.id}">
                <div class="compare-footer-card">
                  <div class ="row">
                    <div class = "col-md-6">
                      <div class="compare-footer-img-container">
                      <img src="https://assets.rumsan.com/askbhunte/assets/bhunte.png" alt="Bank Logo">
                      </div>
                    </div>
                    <div class = "col-md-6 p-0 d-flex flex-row">
                      <button class ="btn-remove d-flex flex-row" id="remove-${checkbox.id}" value="${checkbox.id}" onClick="removeItem(this)">
                        <i class="material-icons mr-1" >
                          remove_circle_outline
                        </i><p>Remove</p> 
                      </button>                     
                    </div>
                  </div>                  
                  <p id="first-text">${checkbox.value}</p>
              </div>
            </div>
          `);  
          
          if(compareCounter == 3){
            
           

            currentLoanData.forEach((el) => {
              if( $(`#${el.bank_id}`)[0].checked ){
                console.log('true');
                $(`#${el.bank_id}`).attr('disabled', false); 
              }
              else{
                console.log('false');
                $(`#${el.bank_id}`).attr('disabled', true);
                $(`#alert-${el.bank_id}`).show();
                
              }
              
            });  
          }     
        }
      }
      else {
        compareCounter--;
        //

        const index = compareId.indexOf(checkbox.id);
        if (index > -1) {
          compareId.splice(index, 1);
          compareName.splice(index, 1);
        }
        console.log('compareId after unchecking', compareId);
        console.log('compareName after unchecking', compareName);
        //        

        $(`#compare-${checkbox.id}`).remove();

        if (compareCounter == 0) {
          $('#compare-div').hide();
        }
        if (compareCounter < 3) {
          /*$('#compare_button').attr("disabled", false);
          console.log('compareCounter', compareCounter);
          console.log('checked');*/
          currentLoanData.forEach((el) => {
              if( $(`#${el.bank_id}`)[0].checked ){
                console.log('true');
                $(`#${el.bank_id}`).attr('disabled', false); 
              }
              else{
                console.log('false');
                $(`#${el.bank_id}`).attr('disabled', false);
                $(`#alert-${el.bank_id}`).hide(); 
              }              
          });

        }
        console.log('compareCounter', compareCounter);
        console.log('unchecked');
      }
      if (compareCounter > 0) {
        $('#compare-div').show();
      }

      if( $('#compare-div').css("display") == "none"){
        console.log('compare-div invisible');
        $('#btnScrollToTop').removeAttr("style");
      }
      else{
        console.log('compare-div visible');
        //$('#btnScrollToTop').css("bottom",$('#compare-div').css('height'));
      }
    }

    function removeItem(el){
      console.log(el);
      compareCounter--;
      const index = compareId.indexOf(el.value);
        if (index > -1) {
          compareId.splice(index, 1);
          compareName.splice(index, 1);
        }
        console.log('comareCounter', compareCounter);
        console.log('compareId after unchecking', compareId);
        console.log('compareName after unchecking', compareName);

        $(`#compare-${el.value}`).remove();
        console.log($(`#${el.value}`)[0].checked);
        
        $(`#${el.value}`)[0].checked = false;
        
        console.log($(`#${el.value}`)[0].checked);

        if (compareCounter == 0) {
          $('#compare-div').hide();
          $('#btnScrollToTop').removeAttr("style");
        }
        if (compareCounter < 3) {          
          currentLoanData.forEach((el) => {
              if( $(`#${el.bank_id}`)[0].checked ){
                console.log('true');
                $(`#${el.bank_id}`).attr('disabled', false); 
              }
              else{
                console.log('false');
                $(`#${el.bank_id}`).attr('disabled', false);
                $(`#alert-${el.bank_id}`).hide(); 
              }              
          });
        }
    }

    $('#compare_button').on('click', () => {      
      window.location.href = `/compare?bank_one=${compareId[0]}&bank_two=${compareId[1]}&bank_three=${compareId[2]}`;      
    });
    /* compare part end */

    /*scroll to top */    
    $('#btnScrollToTop').hide(); 
    $('#btnScrollToTop').on('click', () => {
      window.scrollTo({
        top: 0,
        left: 0,
        behavior: "smooth"
      });
    });
    $(document).ready(function(){     
      $(window).scroll(() => {
        if($(this).scrollTop() > 500){
        $('#btnScrollToTop').show();
        }
        else{
          $('#btnScrollToTop').hide();
        }
      });      
    });
    /*scroll to top */
    
  </script>

</body>

</html>